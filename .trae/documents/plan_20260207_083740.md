# Kế hoạch Điều tra & Sửa lỗi: Chuyển đổi Logic Nhận diện Intent sang JSON

Tôi đã hoàn tất việc điều tra và xác định nguyên nhân sự khác biệt giữa kết quả test và thực tế trên giao diện. Dưới đây là kế hoạch chi tiết để khắc phục vấn đề theo hướng "Test & Fix" đồng thời, loại bỏ logic hardcoded.

## 1. Nguyên nhân Gốc rễ (Root Cause)
- **Logic "Hardcoded" (Nguyên nhân chính):** Backend (`supabase/functions/chat/index.ts`) đang sử dụng Regex và khớp chuỗi văn bản để thực hiện các tác vụ quan trọng:
  - **Trích xuất tên:** Chỉ nhận diện nếu khách nói đúng mẫu câu "tôi tên là..." hoặc "my name is...". Nếu khách nói tự nhiên "Mình là An nhé" -> **Thất bại**.
  - **Gán thẻ (Tagging):** Chỉ gắn tag `Booked Service` nếu câu trả lời của AI có từ "booking" hoặc "đặt". Nếu AI trả lời "Đã xong, hẹn gặp bạn nhé" -> **Thất bại**.
- **Tại sao Test End-to-End vẫn Pass?** Các kịch bản test hiện tại (`test_ai_scenarios.ts`) có thể đang dùng đúng các mẫu câu chuẩn (happy path) nên logic hardcoded vẫn bắt được.
- **Frontend:** Hiện tại chỉ hiển thị tin nhắn văn bản thuần túy, chưa xử lý dữ liệu có cấu trúc.

## 2. Giải pháp: Chuyển sang JSON Intent & Tool-Driven
Thay vì đoán intent qua văn bản, chúng ta sẽ buộc AI trả về dữ liệu JSON hoặc sử dụng tín hiệu từ việc thực thi công cụ (Function Calling) để kích hoạt logic nghiệp vụ.

### Bước 1: Tạo Script Tái hiện Lỗi (Reproduction)
Tạo file `reproduce_issue.ts` để kiểm thử các trường hợp "tự nhiên" mà logic hiện tại đang bỏ sót:
- **Case 1 (Tên):** "Mình là An nhé" (Không dùng "tôi tên").
- **Case 2 (Đặt lịch):** "Giữ cho mình chỗ lúc 2h chiều" (Không dùng từ "đặt lịch").
- **Mục tiêu:** Chứng minh logic cũ thất bại và logic mới sẽ thành công.

### Bước 2: Nâng cấp Backend (`supabase/functions/chat/index.ts`)
- **Bỏ Regex Trích xuất tên:** Xóa đoạn code regex. Cải thiện System Prompt để AI **bắt buộc** phải gọi tool `create_customer` hoặc `update_customer` khi phát hiện tên khách hàng trong ngữ cảnh.
- **Bỏ Text Matching cho Tagging:** Thay vì quét văn bản câu trả lời, logic sẽ dựa vào **hành động thực tế**:
  - Nếu tool `create_booking` chạy thành công -> Tự động gắn tag `Booked Service`.
  - Nếu tool `create_order` chạy thành công -> Tự động gắn tag `Ordered Product`.
- **Chuẩn hóa Phản hồi:** Đảm bảo Edge Function trả về thông tin hành động rõ ràng để Frontend (sau này) có thể hiển thị UI tương ứng.

### Bước 3: Cập nhật Prompt Hệ thống
- Điều chỉnh Prompt để AI ưu tiên trả về cấu trúc dữ liệu chính xác thay vì chỉ chat suông.
- Bổ sung chỉ dẫn rõ ràng: "Khi người dùng cung cấp tên, BẮT BUỘC gọi tool `update_customer` ngay lập tức."

### Bước 4: Kiểm thử & Xác thực
- Chạy lại `reproduce_issue.ts` để xác nhận các trường hợp biên đã được xử lý đúng.
- Kiểm tra lại trên giao diện Embeddable Widget để đảm bảo trải nghiệm người dùng mượt mà.

Tôi đã sẵn sàng thực hiện kế hoạch này. Bạn có đồng ý bắt đầu không?