
# AI Function Fix & Improvement Plan

## 1. Fix Customer Creation Issues
- **Problem**: The AI might be failing to link the new customer to the current conversation context effectively if the `create_customer` tool isn't triggered or if the logic assumes the visitor is already identified.
- **Action**:
  - Review and refine the `create_customer` and `update_customer` tool definitions and prompts to ensure they are biased to execute when name/phone is provided.
  - Ensure the backend logic in `index.ts` correctly updates the `conversations` table with `visitor_name` immediately upon customer creation/update.
  - **Verify**: The reproduction script will explicitly test this flow.

## 2. Enhance AI Task Logs
- **Problem**: The logs are generic ("Executed create_booking") and lack details like addons.
- **Action**:
  - Modify `supabase/functions/chat/index.ts`.
  - In the `task_details` JSON object saved to `ai_task_logs`, specifically format the output for `create_booking` to include the `addons` array.
  - Similarly, for `create_order`, include the `items` list with variant details.
  - **Result**: The UI will display "Booking for [Name] (Addons: A, B)" instead of just generic text.

## 3. Inventory & Slot Safety (Cancellation Logic)
- **Booking Slots**: (Already verified previously) `cancel_booking` decrements the slot count via RPC. I will double-check this in the verification script.
- **Product Stock**:
  - **Current State**: The DB has a trigger `trg_deduct_inventory` that runs only when status changes to `'confirmed'`.
  - **Issue**: If the AI creates an order with status `'pending'` (default in code), stock isn't deducted yet. If it creates as `'confirmed'`, stock is deducted.
  - **Fix**:
    - **Step 3a**: Create a new RPC function `restore_product_stock(order_id)` in the database. This function will look up the order, find the product/variant, and increment the stock back by the quantity.
    - **Step 3b**: Update the `cancel_order` tool in `index.ts` to call this RPC function immediately after setting status to `cancelled`.
    - **Step 3c**: Update `create_order` tool to set status to `'confirmed'` (or ensure the flow handles pending -> confirmed) if we want immediate stock deduction. *Assumption*: For this fix, I will ensure stock is deducted upon creation (by setting confirmed or triggering it) and restored upon cancellation.

## 4. Verification Plan
- Create a script `verify-full-flow.js` that:
  1.  **Customer**: Simulates a new user providing name/phone -> Checks if `customers` table has new record and `conversations` table is updated.
  2.  **Booking**: Simulates booking with addons -> Checks `bookings` table for JSON addons and `ai_task_logs` for detailed log.
  3.  **Order**: Simulates ordering a product -> Checks `orders` table and `products` stock decrement.
  4.  **Cancellation**: Simulates cancelling that order -> Checks `orders` status and `products` stock restoration.

## Milestone
- **Phase 1**: Database RPC for stock restoration.
- **Phase 2**: Update `index.ts` (Logic for logs, cancellation, customer).
- **Phase 3**: Run verification script.
