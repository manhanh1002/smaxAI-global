
# Revenue & Metrics Implementation Plan

## 1. Database Schema Updates
- **Goal**: Store the financial value of every transaction directly on the record to enable historical reporting (even if product prices change later).
- **Action**:
  - Add `total_amount` (numeric) column to `bookings` table.
  - Add `total_amount` (numeric) column to `orders` table.

## 2. Backend Logic Updates (Edge Function `chat/index.ts`)
- **Booking Creation**:
  - Fetch the base price of the `service`.
  - Sum up the prices of all selected `addons`.
  - Save `total_amount = service_price + sum(addon_prices)` to the new booking record.
- **Order Creation**:
  - Fetch the current price from `products` or `product_variants`.
  - Calculate `total_amount = unit_price * quantity`.
  - Save to the new order record.
- **Cancellation**:
  - No DB schema change needed. Revenue calculation queries will simply filter `WHERE status != 'cancelled'`.

## 3. Frontend Updates
- **API/Data Fetching**:
  - Update `useStore` or specific page loaders to fetch `total_amount`.
  - Implement a helper `calculateRevenue(items)` that sums `total_amount` for non-cancelled items.
- **UI Components**:
  - **Orders Page**: Add a "Total Revenue" card at the top.
  - **Bookings Page**: Add a "Total Revenue" card (Service + Addons).
  - **Customers Page**: Add "Lifetime Value" column or stat.
  - **Customer Profile Panel**: Display "Total Spent" metric aggregating both orders and bookings.

## 4. Verification Strategy
- Create a test script `verify-revenue.js`:
  - Create a Booking with Service ($X) + Addon ($Y). Verify `total_amount` = X+Y.
  - Create an Order for 2 items ($Z each). Verify `total_amount` = 2*Z.
  - Cancel one of them.
  - Verify that the "Total Revenue" query correctly excludes the cancelled item.
